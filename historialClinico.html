<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MedBlock - Mi Historial Clínico</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      /* --- Paleta de Colores Profesional --- */
      --primary-brand-color: #005A9C;
      --secondary-brand-color: #007BFF;
      --accent-color: #00BFA5; /* Verde azulado para acentos */
      
      --neutral-darkest: #212529;
      --neutral-dark: #343A40;
      --neutral-medium: #6C757D;
      --neutral-light: #CED4DA;
      --neutral-lighter: #E9ECEF;
      --neutral-lightest: #F8F9FA;

      --background-body: #F4F7FC;
      --surface-primary: #FFFFFF;
      
      --success-color: #28A745;
      --info-color: #17A2B8;
      --warning-color: #FFC107;
      --danger-color: #DC3545;
      --document-color: #6f42c1; /* Púrpura para documentos */


      /* --- Tipografía --- */
      --font-family-primary: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
      --font-family-secondary: 'Open Sans', 'Helvetica Neue', Arial, sans-serif;
      
      /* --- UI Elements --- */
      --border-radius-sm: 5px;
      --border-radius-md: 10px;
      --border-radius-lg: 15px;
      
      --box-shadow-subtle: 0 2px 4px rgba(0, 0, 0, 0.06);
      --box-shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.1);
      --box-shadow-strong: 0 10px 25px rgba(0,0,0,0.12);

      /* --- Transitions & Animations --- */
      --transition-short: 0.2s ease-out;
      --transition-medium: 0.3s ease-out;
      --transition-long: 0.5s cubic-bezier(0.25, 0.8, 0.25, 1);
      
      /* --- Navbar Specific --- */
      --navbar-height: 90px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
    }

    body {
      font-family: var(--font-family-secondary);
      margin: 0;
      padding-top: var(--navbar-height); 
      background-color: var(--background-body);
      color: var(--neutral-dark);
      line-height: 1.7;
      font-size: 16px;
      overflow-x: hidden;
    }

    nav#mainNav {
      background-color: rgba(255, 255, 255, 0.97); 
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: var(--box-shadow-medium);
      border-bottom: 1px solid var(--neutral-lighter);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 1000;
      transition: top 0.4s var(--transition-medium), background-color 0.3s;
      height: var(--navbar-height);
      display: flex;
      align-items: center;
    }
    
    .nav-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        max-width: 1250px; 
        margin: 0 auto;
        padding: 0 25px;
    }

    #mainNav.nav-hidden {
        top: calc(-1 * var(--navbar-height) - 10px);
    }

    .nav-logo img {
        height: 60px; 
        display: block;
    }
    
    .nav-links {
        display: flex;
        align-items: center;
        height: 100%;
    }

    nav#mainNav a.nav-link {
      color: var(--neutral-darkest);
      text-decoration: none;
      font-weight: 600;
      font-family: var(--font-family-secondary);
      padding: 0 20px; 
      margin: 0 10px; 
      border-bottom: 4px solid transparent;
      transition: color var(--transition-short), border-color var(--transition-short);
      font-size: 1.15em; 
      text-transform: uppercase;
      letter-spacing: 0.7px;
      display: inline-flex;
      align-items: center;
      height: 100%;
    }

    nav#mainNav a.nav-link:hover, 
    nav#mainNav a.nav-link:focus, 
    nav#mainNav a.nav-link.active {
      color: var(--primary-brand-color);
      border-bottom-color: var(--primary-brand-color);
    }

    main {
      display: block;
      padding: 50px 20px;
      max-width: 1000px; /* Ajustado para el contenido del historial */
      margin: 40px auto;
    }

    .page-section { /* Clase genérica para secciones de contenido */
      background-color: var(--surface-primary);
      padding: 35px;
      border-radius: var(--border-radius-lg);
      box-shadow: var(--box-shadow-strong);
      margin-bottom: 40px; /* Espacio entre secciones */
      opacity: 0;
      transform: translateY(40px);
      animation-name: sectionFadeInUp;
      animation-duration: 0.8s;
      animation-timing-function: var(--transition-long);
      animation-fill-mode: forwards;
    }
    .page-section:nth-child(1) { animation-delay: 0.1s; }
    .page-section:nth-child(2) { animation-delay: 0.3s; }


    h2 { /* Título principal de la página/sección */
      font-family: var(--font-family-primary);
      color: var(--primary-brand-color);
      margin-top: 0;
      margin-bottom: 30px;
      font-size: 2.2em;
      font-weight: 500;
      border-bottom: 2px solid var(--secondary-brand-color);
      padding-bottom: 15px;
      text-align: center;
    }
    
    h3 { /* Subtítulos dentro de las secciones */
        font-family: var(--font-family-primary);
        color: var(--neutral-darkest);
        font-size: 1.6em;
        margin-top: 0;
        margin-bottom: 20px;
        font-weight: 500;
    }

    /* Estilos para la información del paciente */
    .patient-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .info-item {
        background-color: var(--neutral-lightest);
        padding: 15px;
        border-radius: var(--border-radius-md);
        border-left: 5px solid var(--secondary-brand-color);
    }
    .info-item strong {
        display: block;
        color: var(--primary-brand-color);
        font-weight: 600;
        margin-bottom: 5px;
        font-size: 0.9em;
        text-transform: uppercase;
    }
    .info-item span {
        font-size: 1.05em;
        color: var(--neutral-dark);
        word-break: break-all; /* Para direcciones de billetera largas */
    }

    /* Estilos para las entradas del historial clínico */
    .clinical-entry-list {
        list-style: none;
        padding: 0;
    }
    .clinical-entry-item {
        background-color: var(--surface-primary);
        border: 1px solid var(--neutral-lighter);
        border-radius: var(--border-radius-md);
        padding: 20px 25px;
        margin-bottom: 25px;
        box-shadow: var(--box-shadow-subtle);
        position: relative;
        padding-left: 60px; /* Espacio para el icono/tipo */
        transition: box-shadow var(--transition-medium), transform var(--transition-medium);
    }
    .clinical-entry-item:hover {
        box-shadow: var(--box-shadow-medium);
        transform: translateY(-3px);
    }

    .entry-icon-type { /* Círculo para el tipo de entrada */
        position: absolute;
        left: 15px;
        top: 20px; /* Ajustar si el contenido es más alto */
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.8em;
        font-weight: bold;
    }
    .entry-icon-type.consulta { background-color: var(--info-color); }
    .entry-icon-type.examen { background-color: var(--document-color); } /* Púrpura para exámenes/documentos */
    .entry-icon-type.procedimiento { background-color: var(--accent-color); }
    .entry-icon-type.alerta { background-color: var(--warning-color); color: var(--neutral-darkest); }


    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .entry-header .entry-type {
        font-family: var(--font-family-primary);
        font-size: 1.3em;
        font-weight: 500;
        color: var(--neutral-darkest);
    }
    .entry-header .entry-date {
        font-size: 0.95em;
        color: var(--neutral-medium);
        font-weight: 600;
    }

    .entry-details p {
        margin: 5px 0 10px 0;
        line-height: 1.6;
    }
    .entry-details strong {
        color: var(--neutral-dark);
        font-weight: 600;
    }
    
    .entry-blockchain-link {
        margin-top: 15px;
        font-size: 0.9em;
    }
    .entry-blockchain-link strong {
        color: var(--primary-brand-color);
    }
    .entry-blockchain-link span {
        color: var(--secondary-brand-color);
        font-family: monospace;
        word-break: break-all;
        background-color: var(--neutral-lightest);
        padding: 2px 5px;
        border-radius: var(--border-radius-sm);
    }
    .entry-blockchain-link a {
        color: var(--secondary-brand-color);
        text-decoration: none;
        font-weight: 600;
    }
    .entry-blockchain-link a:hover {
        text-decoration: underline;
    }

    /* --- Keyframe Animations --- */
    @keyframes sectionFadeInUp {
        from { 
            opacity: 0; 
            transform: translateY(40px);
        }
        to { 
            opacity: 1; 
            transform: translateY(0);
        }
    }

    footer {
      background-color: var(--neutral-darkest);
      color: var(--neutral-light);
      text-align: center;
      padding: 50px 20px;
      margin-top: 70px;
      font-size: 1em;
      font-family: var(--font-family-secondary);
    }
    footer p {
        margin: 0 0 10px 0;
    }
    footer p:last-child {
        margin-bottom: 0;
    }
  </style>
</head>
<body>

<nav id="mainNav">
  <div class="nav-container">
    <a href="index.html" class="nav-logo"> 
      <img src="imagenes/logo1.png" alt="MedBlock Logo">
    </a>
    <div class="nav-links">
      <a href="index.html" class="nav-link">Inicio</a> 
      <a href="registrarPaciente.html" class="nav-link">Pacientes</a>
      <a href="registrarmedico.html" class="nav-link">Médicos</a> 
      <a href="historialClinico.html" class="nav-link active">Mi Historial</a> <a href="permisos.html" class="nav-link">Permisos</a> </div>
  </div>
</nav>

<main>
  <section class="page-section" id="patient-summary">
    <h2>Resumen del Paciente</h2>
    <div class="patient-info-grid">
        <div class="info-item">
            <strong>Nombre Completo:</strong>
            <span>Ana Lucía Torres Vega</span>
        </div>
        <div class="info-item">
            <strong>Fecha de Nacimiento:</strong>
            <span>15/08/1985</span>
        </div>
        <div class="info-item">
            <strong>Sexo:</strong>
            <span>Femenino</span>
        </div>
        <div class="info-item">
            <strong>Documento de Identidad:</strong>
            <span>1234567890</span>
        </div>
        <div class="info-item">
            <strong>Teléfono:</strong>
            <span>+593 99 XXX XXXX</span>
        </div>
        <div class="info-item">
            <strong>Billetera Principal Vinculada:</strong>
            <span>0xPac1EnT3Wa11EtAddr3Ss</span>
        </div>
    </div>
  </section>

  <section class="page-section" id="clinical-history-entries">
    <h2>Entradas del Historial Clínico</h2>
    <ul class="clinical-entry-list">
        <li class="clinical-entry-item">
            <div class="entry-icon-type consulta">C</div> <div class="entry-header">
                <span class="entry-type">Consulta Médica General</span>
                <span class="entry-date">15/05/2025</span>
            </div>
            <div class="entry-details">
                <p>Paciente refiere síntomas de resfriado común. Se realiza examen físico.</p>
                <p><strong>Diagnóstico:</strong> Rinofaringitis viral.</p>
                <p><strong>Tratamiento:</strong> Reposo, hidratación, paracetamol SOS.</p>
                <p><strong>Profesional:</strong> Dr. Carlos Rivadeneira</p>
                <p><strong>Institución:</strong> Clínica SaludTotal</p>
            </div>
            <div class="entry-blockchain-link">
                <strong>Registro Blockchain:</strong> <span>Permiso de acceso verificado</span> 
                </div>
        </li>

        <li class="clinical-entry-item">
            <div class="entry-icon-type examen">E</div> <div class="entry-header">
                <span class="entry-type">Radiografía de Tórax (PA y Lateral)</span>
                <span class="entry-date">20/03/2025</span>
            </div>
            <div class="entry-details">
                <p>Se realiza radiografía de tórax por tos persistente. Informe adjunto.</p>
                <p><strong>Hallazgos:</strong> Campos pulmonares bien ventilados, sin evidencia de consolidación ni derrame pleural. Silueta cardíaca de tamaño normal.</p>
                <p><strong>Conclusión:</strong> Sin alteraciones patológicas evidentes.</p>
                <p><strong>Profesional Solicitante:</strong> Dr. Carlos Rivadeneira</p>
                <p><strong>Institución:</strong> Centro de Imágenes Diagnósticas Avanzadas</p>
            </div>
            <div class="entry-blockchain-link">
                <strong>Referencia Blockchain:</strong> Documento verificado/autorizado por <span>0x00552AD000...</span> <br/>
                (Este podría ser el hash del documento o la dirección del profesional/institución que lo registró/verificó)
                <p><a href="#">Acceder al Documento (requiere permiso)</a></p>
            </div>
        </li>
        
        <li class="clinical-entry-item">
            <div class="entry-icon-type examen">E</div>
            <div class="entry-header">
                <span class="entry-type">Análisis de Sangre Completo</span>
                <span class="entry-date">05/02/2025</span>
            </div>
            <div class="entry-details">
                <p>Resultados de hemograma, perfil lipídico y glucosa en ayunas.</p>
                <p><strong>Resultados Destacados:</strong> Colesterol total ligeramente elevado (210 mg/dL). Resto dentro de parámetros normales.</p>
                <p><strong>Recomendaciones:</strong> Dieta y ejercicio. Control en 6 meses.</p>
                <p><strong>Profesional:</strong> Laboratorio BioAnalitics</p>
            </div>
            <div class="entry-blockchain-link">
                 <strong>Registro Blockchain:</strong> <span>Hash de resultados disponible para verificación</span>
            </div>
        </li>

         <li class="clinical-entry-item">
            <div class="entry-icon-type procedimiento">P</div> <div class="entry-header">
                <span class="entry-type">Vacunación Influenza</span>
                <span class="entry-date">10/10/2024</span>
            </div>
            <div class="entry-details">
                <p>Administración de vacuna antigripal tetravalente, temporada 2024-2025.</p>
                <p><strong>Lote:</strong> VXC12345</p>
                <p><strong>Profesional:</strong> Enf. Laura Pérez</p>
                <p><strong>Institución:</strong> Centro de Salud Comunitario</p>
            </div>
            <div class="entry-blockchain-link">
                 <strong>Registro Blockchain:</strong> <span>Certificado de vacunación registrado</span>
            </div>
        </li>
    </ul>
  </section>
</main>

<footer>
  <p>&copy; 2025 MedBlock Solutions. Todos los derechos reservados.</p>
  <p>Transformando la gestión de la salud con tecnología Blockchain para un futuro más seguro y eficiente.</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
<script src="js/web3.js"></script>
<script>
  // JavaScript for Navbar hide/show on scroll
  let lastScrollTop = 0;
  const navbar = document.getElementById('mainNav');
  const navbarHeightVariable = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--navbar-height'));
  const scrollThreshold = navbarHeightVariable / 2; 

  window.addEventListener('scroll', function() {
    let scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    if (scrollTop > lastScrollTop && scrollTop > scrollThreshold) { 
      navbar.classList.add('nav-hidden');
    } else {
      if (scrollTop + window.innerHeight < document.documentElement.scrollHeight || scrollTop === 0) {
        navbar.classList.remove('nav-hidden');
      }
    }
    lastScrollTop = scrollTop <= 0 ? 0 : scrollTop; 
  }, false);

  // Script to update active nav link
  document.addEventListener('DOMContentLoaded', function() {
    const currentPage = window.location.pathname.split('/').pop() || 'inicio.html';
    const navLinks = document.querySelectorAll('.nav-links a.nav-link');

    navLinks.forEach(link => {
      const linkPage = link.getAttribute('href').split('/').pop();
      if (linkPage === currentPage || (currentPage === '' && linkPage === 'historial-clinico.html')) { // Default to current page for empty path
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  });

  // Lógica de control de acceso según el rol
  window.addEventListener('DOMContentLoaded', async function() {
    setTimeout(async () => {
      const rol = await window.obtenerRolWalletConectada();
      const main = document.querySelector('main');
      // Limpiar main
      main.innerHTML = '';
      if (rol === 'medico') {
        // Formulario para registrar historial clínico
        const formSection = document.createElement('section');
        formSection.className = 'page-section';
        formSection.innerHTML = `
          <h2>Registrar Historial Clínico</h2>
          <form id="formHistorial">
            <div class="form-group">
              <label for="paciente">Dirección del Paciente</label>
              <input type="text" id="paciente" required placeholder="0x...">
            </div>
            <div class="form-group">
              <label for="diagnostico">Diagnóstico</label>
              <input type="text" id="diagnostico" required>
            </div>
            <div class="form-group">
              <label for="tratamiento">Tratamiento</label>
              <input type="text" id="tratamiento" required>
            </div>
            <div class="form-group">
              <label for="medicamentos">Medicamentos</label>
              <input type="text" id="medicamentos" required>
            </div>
            <button type="submit">Registrar</button>
          </form>
          <div id="statusHistorial"></div>
          <h3>Historiales que has creado</h3>
          <ul id="listaHistorialesMedico"></ul>
        `;
        main.appendChild(formSection);
        // Manejo del formulario
        document.getElementById('formHistorial').addEventListener('submit', async function(e) {
          e.preventDefault();
          const paciente = document.getElementById('paciente').value;
          const diagnostico = document.getElementById('diagnostico').value;
          const tratamiento = document.getElementById('tratamiento').value;
          const medicamentos = document.getElementById('medicamentos').value;
          const status = document.getElementById('statusHistorial');
          try {
            await crearHistorialClinico(paciente, diagnostico, tratamiento, medicamentos);
            status.textContent = 'Historial registrado exitosamente.';
            status.style.color = 'green';
            this.reset();
            cargarHistorialesMedico();
          } catch (err) {
            status.textContent = 'Error: ' + (err.message || err);
            status.style.color = 'red';
          }
        });
        // Mostrar historiales del médico
        async function cargarHistorialesMedico() {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          const medico = accounts[0];
          const ids = await obtenerHistorialesMedico(medico);
          const lista = document.getElementById('listaHistorialesMedico');
          lista.innerHTML = '';
          for (const id of ids) {
            const h = await obtenerHistorial(id);
            const li = document.createElement('li');
            li.innerHTML = `<b>Paciente:</b> ${h.paciente}<br><b>Diagnóstico:</b> ${h.diagnostico}<br><b>Tratamiento:</b> ${h.tratamiento}<br><b>Medicamentos:</b> ${h.medicamentos}<br><b>Fecha:</b> ${new Date(h.fecha * 1000).toLocaleString()}`;
            lista.appendChild(li);
          }
        }
        cargarHistorialesMedico();
      } else if (rol === 'paciente') {
        // Mostrar historiales del paciente
        const section = document.createElement('section');
        section.className = 'page-section';
        section.innerHTML = `
          <h2>Mi Historial Clínico</h2>
          <ul id="listaHistorialesPaciente"></ul>
        `;
        main.appendChild(section);
        async function cargarHistorialesPaciente() {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          const paciente = accounts[0];
          const ids = await obtenerHistorialesPaciente(paciente);
          const lista = document.getElementById('listaHistorialesPaciente');
          lista.innerHTML = '';
          for (const id of ids) {
            const h = await obtenerHistorial(id);
            const li = document.createElement('li');
            li.innerHTML = `<b>Médico:</b> ${h.medico}<br><b>Diagnóstico:</b> ${h.diagnostico}<br><b>Tratamiento:</b> ${h.tratamiento}<br><b>Medicamentos:</b> ${h.medicamentos}<br><b>Fecha:</b> ${new Date(h.fecha * 1000).toLocaleString()}`;
            lista.appendChild(li);
          }
        }
        cargarHistorialesPaciente();
      } else {
        // No tiene permisos
        const advertencia = document.createElement('div');
        advertencia.style.color = 'red';
        advertencia.style.fontWeight = 'bold';
        advertencia.style.textAlign = 'center';
        advertencia.style.margin = '40px auto';
        advertencia.textContent = 'Debes estar registrado como médico o paciente para acceder a esta sección.';
        main.appendChild(advertencia);
      }
    }, 800);
  });
</script>

</body>
</html>